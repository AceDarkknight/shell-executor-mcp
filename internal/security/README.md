# 安全卫士模块 (security)

## 概述

安全卫士模块负责对输入的 Shell 命令进行安全审计，拦截高危命令和危险参数，防止恶意操作对系统造成损害。

## 文件说明

- `guard.go` - 安全卫士实现，包含命令检查逻辑

## 数据结构

### Guard

安全卫士结构，包含以下字段：

- `blacklistedCommands` - 黑名单命令列表
- `dangerousArgsRegex` - 预编译的危险参数正则表达式列表

## 主要功能

1. **黑名单检查**
   - 检查命令的第一个 Token（命令动词）是否在黑名单中
   - 如果在黑名单中，直接拦截并返回错误

2. **危险参数检查**
   - 使用正则表达式匹配危险参数
   - 支持灵活的模式匹配
   - 可以拦截特定参数组合

3. **命令规范化**
   - 去除首尾空格
   - 压缩多余空格
   - 提取命令动词

## 安全策略

### 黑名单命令

常见黑名单命令包括：

- `rm` - 删除文件或目录
- `mkfs` - 创建文件系统
- `dd` - 低级复制和转换
- `reboot` - 重启系统
- `shutdown` - 关闭系统
- `:(){:|:&};:` - Fork 炸弹

### 危险参数正则

常见危险参数模式：

- `rm\s+-[a-zA-Z]*r[a-zA-Z]*\s+/` - `rm -rf /` 等危险删除命令
- `> /dev/sda` - 直接写入硬盘
- `mkfs.*\s+/dev/` - 格式化磁盘

## 使用示例

```go
// 创建安全卫士
guard, err := security.NewGuard(
    []string{"rm", "mkfs", "shutdown", "reboot"},
    []string{
        `rm\s+-[a-zA-Z]*r[a-zA-Z]*\s+/`,
        `> /dev/sda`,
    },
)
if err != nil {
    log.Fatal(err)
}

// 检查命令
err = guard.CheckCommand("rm -rf /tmp/file")
if err != nil {
    // 命令被拦截
    log.Printf("Security violation: %v", err)
    return
}

// 命令安全，可以执行
```

## 检查算法

1. **规范化命令**
   - 去除首尾空格
   - 压缩多余空格

2. **提取命令动词**
   - 按空格分割命令
   - 第一个 Token 作为命令动词

3. **黑名单检查**
   - 遍历黑名单列表
   - 如果命令动词匹配，返回错误

4. **危险参数检查**
   - 遍历预编译的正则表达式
   - 如果命令匹配任何模式，返回错误

5. **通过检查**
   - 如果所有检查都通过，返回 nil

## 配置示例

在 `server_config.json` 中配置安全规则：

```json
{
  "security": {
    "blacklisted_commands": [
      "rm",
      "mkfs",
      "shutdown",
      "reboot",
      "dd",
      "fdisk"
    ],
    "dangerous_args_regex": [
      "rm\\s+-[a-zA-Z]*r[a-zA-Z]*\\s+/",
      "mkfs.*\\s+/dev/",
      "> /dev/sd[a-z]",
      "dd.*of=/dev/sd[a-z]"
    ]
  }
}
```

## 安全建议

1. **最小权限原则**: 只允许执行必要的命令
2. **白名单优先**: 对于严格的环境，考虑使用白名单而非黑名单
3. **定期审查**: 定期审查和更新安全规则
4. **日志记录**: 记录所有被拦截的命令，便于审计
5. **多层防护**: 结合其他安全措施（如容器隔离、网络隔离）

## 局限性

- 无法检测所有类型的攻击（如命令注入、逻辑漏洞）
- 黑名单模式需要持续维护
- 正则表达式可能存在误报或漏报

## 更新记录

- 2026-01-23: 创建 README.md 文档
