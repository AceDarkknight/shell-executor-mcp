# 需求文档：Shell Executor MCP System

## 1. 项目背景
本项目旨在实现一个基于 MCP (Model Context Protocol) 的 Shell 命令执行系统。该系统允许 Client 端发送 Shell 命令到 Server 端执行，并具备集群分发能力和安全控制机制。

## 2. 用户角色
- **终端用户 (Client User)**: 通过命令行工具输入指令，查看执行结果。
- **运维管理员**: 配置 Server 集群，管理安全策略（黑名单）。

## 3. 功能需求

### 3.1 Client 端
- **命令输入**: 接收用户输入的 Shell 命令。
- **高可用连接 (Failover)**: 
  - 配置多个 Server 地址列表。
  - **自动故障转移**: 按顺序尝试连接 Server，如果连接失败或超时，自动尝试列表中的下一个 Server，直到连接成功或全部失败。
  - 任何一个被连接的 Server 都将充当本次请求的协调节点 (Coordinator)。
- **请求发送**: 将命令封装为 MCP 协议格式发送给连接的 Server。
- **结果展示**: 接收并展示 Server 返回的执行结果。
  - **结果聚合展示**: 对多个节点返回的相同结果进行合并展示（例如：“3 个节点返回了相同的结果...”），避免刷屏。

### 3.2 Server 端
- **MCP 协议支持**: 基于 `github.com/modelcontextprotocol/go-sdk` 实现 MCP Server 标准接口。
- **命令执行**: 在宿主机 Shell 环境中执行接收到的命令。
- **安全控制**:
  - 在执行前对命令进行安全扫描。
  - 拦截高危命令（如 `rm -rf /`, `mkfs` 等）。
  - 支持配置黑名单关键词。
- **集群分发 (Core Feature)**:
  - Server 可配置集群中其他节点的地址。
  - **Coordinator 角色**: 接收 Client 请求的 Server 自动成为 Coordinator。
  - **并发分发**: 使用 Worker Pool 或协程并发向 Peer 节点分发任务，需限制最大并发数以支持大规模节点。
  - **超时控制**: 对 Peer 节点的请求设置严格超时，防止长尾阻塞。
  - **结果聚合与压缩**: 收集所有结果后，按“输出内容”进行分组（Group by Output），将相同输出的节点合并，减少网络传输量。

## 4. 非功能需求
- **语言**: Golang (1.21+)。
- **安全性**: 必须防止恶意的高危操作，具备基础的命令注入防御意识。
- **并发性**: 集群分发需使用并发处理，设置超时时间，避免单节点阻塞导致整体响应慢。
- **可扩展性**: 方便添加新的黑名单规则。

## 5. 约束条件
- 禁止使用 SSH 协议直接连接，必须走 MCP 协议通道（或 HTTP/SSE 承载的 MCP）。
- 遵循 `docs/plan` 中的开发计划。
